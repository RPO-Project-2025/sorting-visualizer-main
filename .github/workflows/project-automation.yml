name: Project Management Automation

on:
  # –û—Å–Ω–æ–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è - —É–±—Ä–∞–ª–∏ –ª–∏—à–Ω–∏–µ —Ç–∏–ø—ã
  issues:
    types: [opened, closed]
  pull_request:
    types: [opened, closed, ready_for_review]

jobs:
  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –≤ –ø—Ä–æ–µ–∫—Ç
  add-to-project:
    runs-on: ubuntu-latest
    steps:
      - name: Add new issues to project
        uses: actions/add-to-project@v0.5.0
        if: github.event_name == 'issues' && github.event.action == 'opened'
        with:
          project-url: https://github.com/orgs/RPO-Project-2025/projects/3
          column-name: 'To Do'
          github-token: ${{ secrets.PROJECT_PAT }}

      - name: Move to In Progress when assigned
        uses: actions/add-to-project@v0.5.0
        if: |
          github.event_name == 'issues' && 
          github.event.action == 'opened' &&
          github.event.issue.assignee != null
        with:
          project-url: https://github.com/orgs/RPO-Project-2025/projects/3
          column-name: 'In Progress'
          github-token: ${{ secrets.PROJECT_PAT }}
          
      - name: Move to Review when PR is ready
        uses: actions/add-to-project@v0.5.0
        if: |
          github.event_name == 'pull_request' && 
          github.event.action == 'ready_for_review'
        with:
          project-url: https://github.com/orgs/RPO-Project-2025/projects/3
          column-name: 'Review'
          github-token: ${{ secrets.PROJECT_PAT }}

      - name: Move to Done when closed
        uses: actions/add-to-project@v0.5.0
        if: |
          (github.event_name == 'issues' || github.event_name == 'pull_request') && 
          github.event.action == 'closed'
        with:
          project-url: https://github.com/orgs/RPO-Project-2025/projects/3
          column-name: 'Done'
          github-token: ${{ secrets.PROJECT_PAT }}

  # –£–º–Ω—ã–µ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π
  telegram-smart-notifications:
    runs-on: ubuntu-latest
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –Ω–µ–≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
    if: |
      (github.event_name == 'issues' && github.event.action == 'opened') ||
      (github.event_name == 'issues' && github.event.action == 'closed') ||
      (github.event_name == 'pull_request' && github.event.action == 'opened') ||
      (github.event_name == 'pull_request' && github.event.action == 'closed') ||
      (github.event_name == 'pull_request' && github.event.action == 'ready_for_review')
    steps:
      - name: Prepare notification data
        id: prepare
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è –∏ –≥–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ
          EVENT_TYPE="${{ github.event_name }}"
          ACTION_TYPE="${{ github.event.action }}"
          
          if [ "$EVENT_TYPE" = "issues" ]; then
            TITLE="${{ github.event.issue.title }}"
            AUTHOR="${{ github.event.issue.user.login }}"
            URL="${{ github.event.issue.html_url }}"
            
            if [ "$ACTION_TYPE" = "opened" ]; then
              EMOJI="üìù"
              ACTION_TEXT="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞"
              
              # –°–æ–±–∏—Ä–∞–µ–º –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–∞—á–µ
              ASSIGNEE="${{ github.event.issue.assignee && github.event.issue.assignee.login || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω' }}"
              LABELS="${{ join(github.event.issue.labels.*.name, ', ') }}"
              
              EXTRA_INFO=""
              if [ -n "$LABELS" ] && [ "$LABELS" != " " ]; then
                EXTRA_INFO="${EXTRA_INFO}üè∑Ô∏è *–ú–µ—Ç–∫–∏:* $LABELS%0A"
              fi
              EXTRA_INFO="${EXTRA_INFO}üë§ *–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:* $ASSIGNEE%0A"
              
            elif [ "$ACTION_TYPE" = "closed" ]; then
              EMOJI="‚úÖ"
              ACTION_TEXT="–ó–∞–¥–∞—á–∞ –∑–∞–∫—Ä—ã—Ç–∞"
              CLOSED_BY="${{ github.event.issue.closed_by && github.event.issue.closed_by.login || github.event.sender.login }}"
              EXTRA_INFO="üîí *–ó–∞–∫—Ä—ã–ª:* $CLOSED_BY%0A"
            fi
            
          elif [ "$EVENT_TYPE" = "pull_request" ]; then
            TITLE="${{ github.event.pull_request.title }}"
            AUTHOR="${{ github.event.pull_request.user.login }}"
            URL="${{ github.event.pull_request.html_url }}"
            BRANCH_FROM="${{ github.event.pull_request.head.ref }}"
            BRANCH_TO="${{ github.event.pull_request.base.ref }}"
            
            case "$ACTION_TYPE" in
              "opened")
                EMOJI="üîÄ"
                ACTION_TEXT="–ù–æ–≤—ã–π Pull Request"
                EXTRA_INFO="üåø *–ò–∑:* $BRANCH_FROM%0AüéØ *–í:* $BRANCH_TO%0A"
                ;;
              "closed")
                EMOJI="‚úÖ"
                if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                  ACTION_TEXT="PR –≤–º–µ—Ä–∂–µ–Ω"
                  EXTRA_INFO="üîÑ *–°—Ç–∞—Ç—É—Å:* –í–º–µ—Ä–∂–µ–Ω%0A"
                else
                  ACTION_TEXT="PR –∑–∞–∫—Ä—ã—Ç"
                  EXTRA_INFO="üö´ *–°—Ç–∞—Ç—É—Å:* –ó–∞–∫—Ä—ã—Ç%0A"
                fi
                ;;
              "ready_for_review")
                EMOJI="üëÄ"
                ACTION_TEXT="PR –≥–æ—Ç–æ–≤ –∫ —Ä–µ–≤—å—é"
                EXTRA_INFO=""
                ;;
            esac
          fi
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ output
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "action_text=$ACTION_TEXT" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "extra_info=$EXTRA_INFO" >> $GITHUB_OUTPUT

      - name: Send smart Telegram notification
        env:
          EMOJI: ${{ steps.prepare.outputs.emoji }}
          ACTION_TEXT: ${{ steps.prepare.outputs.action_text }}
          TITLE: ${{ steps.prepare.outputs.title }}
          AUTHOR: ${{ steps.prepare.outputs.author }}
          URL: ${{ steps.prepare.outputs.url }}
          EXTRA_INFO: ${{ steps.prepare.outputs.extra_info }}
        run: |
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          MESSAGE="$EMOJI *$ACTION_TEXT*%0A%0A"
          
          if [ -n "$TITLE" ] && [ "$TITLE" != " " ]; then
            MESSAGE="${MESSAGE}üìå *–ó–∞–≥–æ–ª–æ–≤–æ–∫:* $TITLE%0A"
          fi
          
          MESSAGE="${MESSAGE}üë§ *–ê–≤—Ç–æ—Ä:* $AUTHOR%0A"
          MESSAGE="${MESSAGE}$EXTRA_INFO"
          MESSAGE="${MESSAGE}üîó *–°—Å—ã–ª–∫–∞:* $URL"
          
          echo "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram..."
          echo "–¢–µ–∫—Å—Ç: $MESSAGE"
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
          RESPONSE=$(curl -s -w "%{http_code}" -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "message_thread_id=2" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"
            exit 1
          else
            echo "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram"
          fi
