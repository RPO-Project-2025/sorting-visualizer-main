name: Project Management Automation

on:
  issues:
    types: [opened, labeled, assigned, closed]
  pull_request:
    types: [opened, labeled, assigned, closed, ready_for_review]

jobs:
  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –≤ –ø—Ä–æ–µ–∫—Ç
  add-to-project:
    runs-on: ubuntu-latest
    steps:
      - name: Add new issues to project
        uses: actions/add-to-project@v0.5.0
        if: github.event_name == 'issues' && github.event.action == 'opened'
        with:
          project-url: https://github.com/orgs/RPO-Project-2025/projects/3
          column-name: 'To Do'
          github-token: ${{ secrets.PROJECT_PAT }}

  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç –∑–∞–¥–∞—á–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
  move-on-status-change:
    runs-on: ubuntu-latest
    steps:
      - name: Move to In Progress when assigned
        uses: actions/add-to-project@v0.5.0
        if: |
          github.event_name == 'issues' && 
          github.event.action == 'assigned'
        with:
          project-url: https://github.com/orgs/RPO-Project-2025/projects/3
          column-name: 'In Progress'
          github-token: ${{ secrets.PROJECT_PAT }}
          
      - name: Move to Review when PR is ready
        uses: actions/add-to-project@v0.5.0
        if: |
          github.event_name == 'pull_request' && 
          github.event.action == 'ready_for_review'
        with:
          project-url: https://github.com/orgs/RPO-Project-2025/projects/3
          column-name: 'Review'
          github-token: ${{ secrets.PROJECT_PAT }}

      - name: Move to Done when closed
        uses: actions/add-to-project@v0.5.0
        if: |
          (github.event_name == 'issues' || github.event_name == 'pull_request') && 
          github.event.action == 'closed'
        with:
          project-url: https://github.com/orgs/RPO-Project-2025/projects/3
          column-name: 'Done'
          github-token: ${{ secrets.PROJECT_PAT }}

  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram –æ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö
  telegram-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Send notification to Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            üéØ *${{ github.repository }}*
            
            ${{ github.event_name == 'issues' && github.event.action == 'opened' && format('üìù *–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞*: {0}\nüë§ *–ê–≤—Ç–æ—Ä*: {1}\nüîó *–°—Å—ã–ª–∫–∞*: {2}\nüè∑Ô∏è *–ú–µ—Ç–∫–∏*: {3}', github.event.issue.title, github.event.issue.user.login, github.event.issue.html_url, join(github.event.issue.labels.*.name, ', ')) || '' }}
            
            ${{ github.event_name == 'issues' && github.event.action == 'closed' && format('‚úÖ *–ó–∞–¥–∞—á–∞ –∑–∞–∫—Ä—ã—Ç–∞*: {0}\nüë§ *–ó–∞–∫—Ä—ã–ª*: {1}', github.event.issue.title, github.event.issue.user.login) || '' }}
            
            ${{ github.event_name == 'pull_request' && github.event.action == 'opened' && format('üîÄ *–ù–æ–≤—ã–π Pull Request*: {0}\nüë§ *–ê–≤—Ç–æ—Ä*: {1}\nüîó *–°—Å—ã–ª–∫–∞*: {2}', github.event.pull_request.title, github.event.pull_request.user.login, github.event.pull_request.html_url) || '' }}
            
            ${{ github.event_name == 'pull_request' && github.event.action == 'ready_for_review' && format('üëÄ *PR –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ*: {0}\nüë§ *–ê–≤—Ç–æ—Ä*: {1}', github.event.pull_request.title, github.event.pull_request.user.login) || '' }}
            
            ${{ (github.event_name != 'issues' && github.event_name != 'pull_request') && format('‚ÑπÔ∏è *–°–æ–±—ã—Ç–∏–µ*: {0} - {1}', github.event_name, github.event.action) || '' }}
          format: "html"
