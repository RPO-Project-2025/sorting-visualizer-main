name: Project Management Automation

on:
  issues:
    types: [opened, closed, edited, assigned, unassigned, labeled, unlabeled]
  pull_request:
    types: [opened, closed, edited, ready_for_review, review_requested, assigned, unassigned, labeled, unlabeled]
  project_card:
    types: [created, moved, deleted]

jobs:
  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –≤ –ø—Ä–æ–µ–∫—Ç
  add-to-project:
    runs-on: ubuntu-latest
    steps:
      - name: Add new issues to project
        uses: actions/add-to-project@v0.5.0
        if: github.event_name == 'issues' && github.event.action == 'opened'
        with:
          project-url: https://github.com/orgs/RPO-Project-2025/projects/3
          column-name: 'To Do'
          github-token: ${{ secrets.PROJECT_PAT }}

      - name: Move to In Progress when assigned
        uses: actions/add-to-project@v0.5.0
        if: |
          github.event_name == 'issues' && 
          github.event.action == 'assigned'
        with:
          project-url: https://github.com/orgs/RPO-Project-2025/projects/3
          column-name: 'In Progress'
          github-token: ${{ secrets.PROJECT_PAT }}
          
      - name: Move to Review when PR is ready
        uses: actions/add-to-project@v0.5.0
        if: |
          github.event_name == 'pull_request' && 
          github.event.action == 'ready_for_review'
        with:
          project-url: https://github.com/orgs/RPO-Project-2025/projects/3
          column-name: 'Review'
          github-token: ${{ secrets.PROJECT_PAT }}

      - name: Move to Done when closed
        uses: actions/add-to-project@v0.5.0
        if: |
          (github.event_name == 'issues' || github.event_name == 'pull_request') && 
          github.event.action == 'closed'
        with:
          project-url: https://github.com/orgs/RPO-Project-2025/projects/3
          column-name: 'Done'
          github-token: ${{ secrets.PROJECT_PAT }}

  # –£–º–Ω—ã–µ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  telegram-smart-notifications:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare notification data
        id: prepare
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è –∏ –≥–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ
          EVENT_TYPE="${{ github.event_name }}"
          ACTION_TYPE="${{ github.event.action }}"
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º –±–∞–∑–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          if [ "$EVENT_TYPE" = "issues" ]; then
            TITLE="${{ github.event.issue.title }}"
            AUTHOR="${{ github.event.issue.user.login }}"
            URL="${{ github.event.issue.html_url }}"
            ASSIGNEE="${{ github.event.issue.assignee && github.event.issue.assignee.login || '' }}"
            LABELS="${{ join(github.event.issue.labels.*.name, ', ') }}"
            
            case "$ACTION_TYPE" in
              "opened")
                EMOJI="üìù"
                ACTION_TEXT="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞"
                EXTRA_INFO=""
                if [ -n "$LABELS" ]; then
                  EXTRA_INFO="üè∑Ô∏è *–ú–µ—Ç–∫–∏:* $LABELS%0A"
                fi
                if [ -n "$ASSIGNEE" ]; then
                  EXTRA_INFO="${EXTRA_INFO}üë§ *–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:* $ASSIGNEE%0A"
                fi
                ;;
              "closed")
                EMOJI="‚úÖ"
                ACTION_TEXT="–ó–∞–¥–∞—á–∞ –∑–∞–∫—Ä—ã—Ç–∞"
                EXTRA_INFO=""
                ;;
              "assigned")
                EMOJI="üë§"
                ACTION_TEXT="–ù–∞–∑–Ω–∞—á–µ–Ω –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å"
                ASSIGNER="${{ github.event.sender.login }}"
                EXTRA_INFO="üìå *–ù–∞–∑–Ω–∞—á–∏–ª:* $ASSIGNER%0Aüë§ *–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:* $ASSIGNEE%0A"
                ;;
              "unassigned")
                EMOJI="üö´"
                ACTION_TEXT="–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω"
                EXTRA_INFO="üë§ *–ë—ã–ª –Ω–∞–∑–Ω–∞—á–µ–Ω:* $ASSIGNEE%0A"
                ;;
              "labeled")
                EMOJI="üè∑Ô∏è"
                ACTION_TEXT="–î–æ–±–∞–≤–ª–µ–Ω–∞ –º–µ—Ç–∫–∞"
                LABEL_ADDED="${{ github.event.label.name }}"
                EXTRA_INFO="üìå *–ú–µ—Ç–∫–∞:* $LABEL_ADDED%0A"
                ;;
              "unlabeled")
                EMOJI="üè∑Ô∏è"
                ACTION_TEXT="–£–¥–∞–ª–µ–Ω–∞ –º–µ—Ç–∫–∞"
                LABEL_REMOVED="${{ github.event.label.name }}"
                EXTRA_INFO="üìå *–ú–µ—Ç–∫–∞:* $LABEL_REMOVED%0A"
                ;;
              *)
                EMOJI="‚ÑπÔ∏è"
                ACTION_TEXT="–ò–∑–º–µ–Ω–µ–Ω–∞ –∑–∞–¥–∞—á–∞"
                EXTRA_INFO=""
                ;;
            esac
            
          elif [ "$EVENT_TYPE" = "pull_request" ]; then
            TITLE="${{ github.event.pull_request.title }}"
            AUTHOR="${{ github.event.pull_request.user.login }}"
            URL="${{ github.event.pull_request.html_url }}"
            BRANCH_FROM="${{ github.event.pull_request.head.ref }}"
            BRANCH_TO="${{ github.event.pull_request.base.ref }}"
            
            case "$ACTION_TYPE" in
              "opened")
                EMOJI="üîÄ"
                ACTION_TEXT="–ù–æ–≤—ã–π Pull Request"
                EXTRA_INFO="üåø *–ò–∑:* $BRANCH_FROM%0AüéØ *–í:* $BRANCH_TO%0A"
                ;;
              "closed")
                EMOJI="‚úÖ"
                if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                  ACTION_TEXT="PR –≤–º–µ—Ä–∂–µ–Ω"
                  EXTRA_INFO="üîÑ *–°—Ç–∞—Ç—É—Å:* –í–º–µ—Ä–∂–µ–Ω%0A"
                else
                  ACTION_TEXT="PR –∑–∞–∫—Ä—ã—Ç"
                  EXTRA_INFO="üö´ *–°—Ç–∞—Ç—É—Å:* –ó–∞–∫—Ä—ã—Ç%0A"
                fi
                ;;
              "ready_for_review")
                EMOJI="üëÄ"
                ACTION_TEXT="PR –≥–æ—Ç–æ–≤ –∫ —Ä–µ–≤—å—é"
                EXTRA_INFO=""
                ;;
              "review_requested")
                EMOJI="üìã"
                ACTION_TEXT="–ó–∞–ø—Ä–æ—à–µ–Ω–æ —Ä–µ–≤—å—é"
                REVIEWER="${{ github.event.requested_reviewer.login }}"
                EXTRA_INFO="üë§ *–†–µ–≤—å—é–µ—Ä:* $REVIEWER%0A"
                ;;
              *)
                EMOJI="‚ÑπÔ∏è"
                ACTION_TEXT="–ò–∑–º–µ–Ω–µ–Ω PR"
                EXTRA_INFO=""
                ;;
            esac
          else
            EMOJI="‚öôÔ∏è"
            ACTION_TEXT="–°–æ–±—ã—Ç–∏–µ –ø—Ä–æ–µ–∫—Ç–∞"
            TITLE=""
            AUTHOR="${{ github.actor }}"
            URL="https://github.com/${{ github.repository }}"
            EXTRA_INFO=""
          fi
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ output
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "action_text=$ACTION_TEXT" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "extra_info=$EXTRA_INFO" >> $GITHUB_OUTPUT

      - name: Send smart Telegram notification
        env:
          EMOJI: ${{ steps.prepare.outputs.emoji }}
          ACTION_TEXT: ${{ steps.prepare.outputs.action_text }}
          TITLE: ${{ steps.prepare.outputs.title }}
          AUTHOR: ${{ steps.prepare.outputs.author }}
          URL: ${{ steps.prepare.outputs.url }}
          EXTRA_INFO: ${{ steps.prepare.outputs.extra_info }}
        run: |
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          MESSAGE="$EMOJI *$ACTION_TEXT*%0A%0A"
          
          if [ -n "$TITLE" ]; then
            MESSAGE="${MESSAGE}üìå *–ó–∞–≥–æ–ª–æ–≤–æ–∫:* $TITLE%0A"
          fi
          
          MESSAGE="${MESSAGE}üë§ *–ê–≤—Ç–æ—Ä:* $AUTHOR%0A"
          MESSAGE="${MESSAGE}$EXTRA_INFO"
          MESSAGE="${MESSAGE}üîó *–°—Å—ã–ª–∫–∞:* $URL"
          
          echo "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram..."
          echo "–¢–µ–∫—Å—Ç: $MESSAGE"
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
          RESPONSE=$(curl -s -w "%{http_code}" -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "message_thread_id=2" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"
            exit 1
          else
            echo "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram"
          fi

  # –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)
  weekly-report:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Send weekly progress report
        run: |
          MESSAGE="üìä *–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç—É*%0A%0A"
          MESSAGE="${MESSAGE}üèÜ *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é*%0A"
          MESSAGE="${MESSAGE}üìù –ù–æ–≤—ã–µ –∑–∞–¥–∞—á–∏: ?%0A"
          MESSAGE="${MESSAGE}‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏: ?%0A"
          MESSAGE="${MESSAGE}üîÄ –°–æ–∑–¥–∞–Ω–Ω—ã–µ PR: ?%0A"
          MESSAGE="${MESSAGE}%0A"
          MESSAGE="${MESSAGE}üí° *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:*%0A"
          MESSAGE="${MESSAGE}‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏%0A"
          MESSAGE="${MESSAGE}‚Ä¢ –ó–∞–ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ —Ä–∞–±–æ—Ç—É –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é%0A"
          MESSAGE="${MESSAGE}‚Ä¢ –ü—Ä–æ–≤–µ–¥–∏—Ç–µ –∫–æ–¥-—Ä–µ–≤—å—é –æ—Ç–∫—Ä—ã—Ç—ã—Ö PR"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "message_thread_id=2" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown"

# –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ (–∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 10:00)
schedule:
  - cron: '0 10 * * 0'
