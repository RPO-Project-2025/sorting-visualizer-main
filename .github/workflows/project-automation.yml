name: Project Management Automation

on:
  issues:
    types: [opened, labeled, assigned, closed]
  pull_request:
    types: [opened, labeled, assigned, closed, ready_for_review]

jobs:
  add-to-project:
    runs-on: ubuntu-latest
    steps:
      - name: Add new issues to project
        uses: actions/add-to-project@v0.5.0
        if: github.event_name == 'issues' && github.event.action == 'opened'
        with:
          project-url: https://github.com/orgs/RPO-Project-2025/projects/3
          column-name: 'To Do'
          github-token: ${{ secrets.PROJECT_PAT }}

  move-on-status-change:
    runs-on: ubuntu-latest
    steps:
      - name: Move to In Progress when assigned
        uses: actions/add-to-project@v0.5.0
        if: |
          github.event_name == 'issues' && 
          github.event.action == 'assigned'
        with:
          project-url: https://github.com/orgs/RPO-Project-2025/projects/3
          column-name: 'In Progress'
          github-token: ${{ secrets.PROJECT_PAT }}
          
      - name: Move to Review when PR is ready
        uses: actions/add-to-project@v0.5.0
        if: |
          github.event_name == 'pull_request' && 
          github.event.action == 'ready_for_review'
        with:
          project-url: https://github.com/orgs/RPO-Project-2025/projects/3
          column-name: 'Review'
          github-token: ${{ secrets.PROJECT_PAT }}

      - name: Move to Done when closed
        uses: actions/add-to-project@v0.5.0
        if: |
          (github.event_name == 'issues' || github.event_name == 'pull_request') && 
          github.event.action == 'closed'
        with:
          project-url: https://github.com/orgs/RPO-Project-2025/projects/3
          column-name: 'Done'
          github-token: ${{ secrets.PROJECT_PAT }}

    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram –æ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö
  telegram-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Send notification to Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            üéØ *${{ github.repository }}*
            
            {% raw %}
            {% if github.event_name == 'issues' and github.event.action == 'opened' %}
            üìù *–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞*: ${{ github.event.issue.title }}
            üë§ *–ê–≤—Ç–æ—Ä*: ${{ github.event.issue.user.login }}
            üîó *–°—Å—ã–ª–∫–∞*: ${{ github.event.issue.html_url }}
            {% if github.event.issue.labels[0] %}üè∑Ô∏è *–ú–µ—Ç–∫–∏*: {% for label in github.event.issue.labels %}${{ label.name }}{% if not forloop.last %}, {% endif %}{% endfor %}{% endif %}
            
            {% elsif github.event_name == 'issues' and github.event.action == 'closed' %}
            ‚úÖ *–ó–∞–¥–∞—á–∞ –∑–∞–∫—Ä—ã—Ç–∞*: ${{ github.event.issue.title }}
            üë§ *–ó–∞–∫—Ä—ã–ª*: ${{ github.event.issue.user.login }}
            
            {% elsif github.event_name == 'pull_request' and github.event.action == 'opened' %}
            üîÄ *–ù–æ–≤—ã–π Pull Request*: ${{ github.event.pull_request.title }}
            üë§ *–ê–≤—Ç–æ—Ä*: ${{ github.event.pull_request.user.login }}
            üîó *–°—Å—ã–ª–∫–∞*: ${{ github.event.pull_request.html_url }}
            
            {% elsif github.event_name == 'pull_request' and github.event.action == 'ready_for_review' %}
            üëÄ *PR –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ*: ${{ github.event.pull_request.title }}
            üë§ *–ê–≤—Ç–æ—Ä*: ${{ github.event.pull_request.user.login }}
            
            {% else %}
            ‚ÑπÔ∏è *–°–æ–±—ã—Ç–∏–µ*: ${{ github.event_name }} - ${{ github.event.action }}
            {% endif %}
            {% endraw %}
          format: "html"
